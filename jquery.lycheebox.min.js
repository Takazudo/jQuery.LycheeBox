/*! jQuery.LycheeBox (https://github.com/Takazudo/jQuery.LycheeBox)
 * lastupdate: 2013-10-01
 * version: 0.0.0
 * author: 'Takazudo' Takeshi Takatsudo <takazudo@gmail.com>
 * License: MIT */
!function(){!function(a){var b,c,d,e;return c=a(window),b=a(document),d=null,e={},e.setup=function(){var b;return b=!1,function(){return b?void 0:(b=!0,a.ui.domwindowdialog.setup({width:600,height:300}),d=window.domwindowApi)}}(),e.viewport={width:function(){return c.width()},height:function(){return window.innerHeight||c.height()},createSizeObject:function(){var a;return a={width:e.viewport.width(),height:e.viewport.height()}}},e.Dialog=function(){function f(b,c){this.$opener=b,this.options=a.extend({},e.Dialog.defaults,c),this._eventify()}return f.defaults={dialog_src:'<div class="lycheebox-dialog">\n  <div class="lycheebox-positioner">\n    <div class="lycheebox-main">\n      <div class="lycheebox-main-inner">\n        <div class="lycheebox-imgholder"></div>\n        <a class="lycheebox-dialogcloser apply-domwindow-close" href="#">close</a>\n      </div>\n    </div>\n  </div>\n  <div class="lycheebox-loader"></div>\n</div>',spinner_options:{color:"#fff",lines:20,length:10,width:2,radius:40},selector_dialogRoot:".lycheebox-dialog",selector_loader:".lycheebox-loader",selector_holder:".lycheebox-imgholder",selector_main:".lycheebox-main",dialog_LR_margin:10,dialog_TB_margin:10,dialog_LR_padding:10,dialog_TB_padding:10,dialog_closer_height:35},f.prototype.open=function(){var b,c,f=this;return e.setup(),b=a.trim(this.options.dialog_src),c=a.extend({strdialog:!0,tandbmargintodecideposition:0,afteropen:function(a,b){return f.$dialog=b.dialog,f._handleAfterOpen()},beforeclose:function(){return f.$dialog=null,f._handleBeforeClose()}},e.viewport.createSizeObject()),d.open(this.options.dialog_src,c)},f.prototype.destroy=function(){return this.$opener.unbind("click",this._openerClickHandler),c.unbind("resize orientationchange",this._resizeHandler)},f.prototype.resizeDialog=function(){var a;if(this.opened)return a=e.viewport.createSizeObject(),this.$dialog.css(a)},f.prototype.resizeEls=function(){var b,c,d,f,g;if(this.opened&&this.imgReady)return f=this.options,c=a.imgUtil.calcRectContainImgWH({imgWidth:this.naturalImgSize.width,imgHeight:this.naturalImgSize.height,rectWidth:e.viewport.width()-2*f.dialog_LR_margin-2*f.dialog_LR_padding,rectHeight:e.viewport.height()-2*f.dialog_TB_margin-2*f.dialog_TB_padding-f.dialog_closer_height,enlargeSmallImg:!1}),g=c.width+2*f.dialog_LR_padding,b=c.height+2*f.dialog_TB_padding+f.dialog_closer_height,d={width:g,height:b,marginTop:-1*b/2,marginLeft:-1*g/2},this.$main.css(d),this.$holder.css(c)},f.prototype._handleAfterOpen=function(){var a=this;return this.opened=!0,this.imgsrc=this.$opener.attr("href"),this._eventify_overlayClickClose(),this._putSpinner(),this._calcImgSize().then(function(){return a._removeSpinner()}).then(function(){return a._prepareElsInsideDialog(),a.$holder.append(a.$img),a.imgReady=!0,a.resizeEls(),a.$main.fadeIn()})},f.prototype._handleBeforeClose=function(){return this.opened=!1,this.imgReady=!1,this._uneventify_overlayClickClose()},f.prototype._eventify_overlayClickClose=function(){var c;return c=this.options,this._overlayClickHandler=function(b){var e;return e=a(b.target),e.is(""+c.selector_loader+", "+c.selector_dialogRoot)?d.close():void 0},b.delegate(c.selector_dialogRoot,"click",this._overlayClickHandler)},f.prototype._uneventify_overlayClickClose=function(){var a;return a=this.options,b.undelegate(a.selector_dialogRoot,"click",this._overlayClickHandler)},f.prototype._putSpinner=function(){var b;return b=this.options,this.$loader=a(b.selector_loader,this.$dialog),new Spinner(b.spinner_options).spin(this.$loader[0])},f.prototype._calcImgSize=function(){var b,c=this;return b=a.Deferred(),a.imgUtil.calcNaturalWH(this.imgsrc).done(function(a,d){return c.naturalImgSize=a,c.$img=d,b.resolve()}),b.promise()},f.prototype._removeSpinner=function(){var b,c=this;return b=a.Deferred(),a.when(this.$loader.fadeOut()).done(function(){return c.$loader.empty().remove(),b.resolve()}),b.promise()},f.prototype._eventify=function(){var a=this;return this._openerClickHandler=function(b){return b.preventDefault(),a.open()},this._resizeHandler=function(){return a.resizeDialog(),a.resizeEls()},this.$opener.bind("click",this._openerClickHandler),c.bind("resize orientationchange",this._resizeHandler)},f.prototype._prepareElsInsideDialog=function(){return this.$main=a(this.options.selector_main,this.$dialog),this.$holder=a(this.options.selector_holder,this.$dialog)},f}(),a.fn.lycheeBox=function(b){return this.each(function(c,d){var f,g;return f=a(d),g=f.data("lycheebox"),null!=g&&g.destroy(),g=new e.Dialog(f,b),f.data("liycheebox",g)})},a.LycheeBox=e}(jQuery)}.call(this);