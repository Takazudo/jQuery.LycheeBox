/*! jQuery.LycheeBox (https://github.com/Takazudo/jQuery.LycheeBox)
 * lastupdate: 2014-11-15
 * version: 0.0.0
 * author: 'Takazudo' Takeshi Takatsudo <takazudo@gmail.com>
 * License: MIT */
(function(){!function(a){var b,c,d,e,f;return c=a(window),b=a(document),d=null,e={},f=function(b){return a.Deferred(function(a){return setTimeout(function(){return a.resolve()},b)}).promise()},e.setup=function(){var b;return b=!1,function(c){return c||!b?(b=!0,a.ui.domwindowdialog.setup({width:600,height:300}),d=window.domwindowApi):void 0}}(),e.viewport={width:function(){return c.width()},height:function(){return window.innerHeight||c.height()},createSizeObject:function(){var a;return a={width:e.viewport.width(),height:e.viewport.height()}}},e.fadeIn=function(a,b){var c,d;return null==b&&(b=400),c={display:"block",opacity:0},d={opacity:1},a.css(c).animate(d,b)},e.fadeOut=function(a,b){var c,d;return null==b&&(b=400),c={display:"block",opacity:1},d={opacity:0},a.css(c).animate(d,b)},e.Dialog=function(){function b(b,c){this.$opener=b,this.options=a.extend({},e.Dialog.defaults,c),this._eventify()}return b.defaults={dialog_src:'<div class="lycheebox-dialog">\n  <div class="lycheebox-positioner">\n    <div class="lycheebox-main">\n      <div class="lycheebox-main-inner">\n        <div class="lycheebox-imgholder"></div>\n        <a class="lycheebox-dialogcloser apply-domwindow-close" href="#">close</a>\n      </div>\n    </div>\n  </div>\n  <div class="lycheebox-loader"></div>\n</div>',spinner_options:{color:"#fff",lines:20,length:10,width:2,radius:40},selector_dialogRoot:".lycheebox-dialog",selector_loader:".lycheebox-loader",selector_holder:".lycheebox-imgholder",selector_main:".lycheebox-main",dialog_LR_margin:10,dialog_TB_margin:10,dialog_LR_padding:10,dialog_TB_padding:10,dialog_closer_height:35,dialog_click_close:!0,prevent_touchmove:!0,setup_domwindow_on_everyopen:!1},b.prototype.open=function(){var b,c,f=this;return e.setup(this.options.setup_domwindow_on_everyopen),b=a.trim(this.options.dialog_src),c=a.extend({strdialog:!0,tandbmargintodecideposition:0,afteropen:function(a,b){return f.$dialog=b.dialog,f._handleAfterOpen()},beforeclose:function(){return f._handleBeforeClose()},afterclose:function(){return f.$dialog.empty(),f.$dialog=null}},e.viewport.createSizeObject()),d.open(this.options.dialog_src,c)},b.prototype.destroy=function(){return this.$opener.unbind("click",this._openerClickHandler),c.unbind("resize orientationchange",this._resizeHandler)},b.prototype.resizeDialog=function(){var a;if(this.opened)return a=e.viewport.createSizeObject(),this.$dialog.css(a)},b.prototype.resizeEls=function(){var b,c,d,f,g;if(this.opened&&this.imgReady)return f=this.options,c=a.imgUtil.calcRectContainImgWH({imgWidth:this.naturalImgSize.width,imgHeight:this.naturalImgSize.height,rectWidth:e.viewport.width()-2*f.dialog_LR_margin-2*f.dialog_LR_padding,rectHeight:e.viewport.height()-2*f.dialog_TB_margin-2*f.dialog_TB_padding-f.dialog_closer_height,enlargeSmallImg:!1}),g=c.width+2*f.dialog_LR_padding,b=c.height+2*f.dialog_TB_padding+f.dialog_closer_height,d={width:g,height:b,marginTop:-1*b/2,marginLeft:-1*g/2},this.$main.css(d),this.$holder.css(c)},b.prototype._handleAfterOpen=function(){var a=this;return this.opened=!0,this.imgsrc=this.$opener.attr("href"),this._eventify_overlayClickClose(),this._eventify_dialogTouchmove(),this._putSpinner(),this._calcImgSize().then(function(){return a._removeSpinner()}).then(function(){return a._prepareElsInsideDialog(),a.$holder.append(a.$img),a.imgReady=!0,a.resizeEls(),e.fadeIn(a.$main)})},b.prototype._handleBeforeClose=function(){return this.opened=!1,this.imgReady=!1,this._uneventify_overlayClickClose(),this._uneventify_overlayClickClose()},b.prototype._eventify_dialogTouchmove=function(){return this.options.prevent_touchmove?(this._touchmoveHandler=function(a){return a.preventDefault()},this.$dialog.bind("touchmove",this._touchmoveHandler)):void 0},b.prototype._uneventify_dialogTouchmove=function(){return this.options.prevent_touchmove?this.$dialog.unbind("touchmove",this._touchmoveHandler):void 0},b.prototype._eventify_overlayClickClose=function(){var b;if(this.options.dialog_click_close)return b=this.options,this._overlayClickHandler=function(c){var e;return e=a(c.target),e.is(""+b.selector_loader+", "+b.selector_dialogRoot)?d.close():void 0},this.$dialog.bind("click",this._overlayClickHandler)},b.prototype._uneventify_overlayClickClose=function(){return this.options.dialog_click_close?this.$dialog.unbind("click",this._overlayClickHandler):void 0},b.prototype._putSpinner=function(){var b;return b=this.options,this.$loader=a(b.selector_loader,this.$dialog),this.$loader.stop().css({display:"block",opacity:0}),new Spinner(b.spinner_options).spin(this.$loader[0]),e.fadeIn(this.$loader,200)},b.prototype._calcImgSize=function(){var b,c=this;return b=a.Deferred(),a.imgUtil.calcNaturalWH(this.imgsrc).done(function(a,d){return c.naturalImgSize=a,c.$img=d,b.resolve()}),b.promise()},b.prototype._removeSpinner=function(){var b,c=this;return b=a.Deferred(),a.when(e.fadeOut(this.$loader)).done(function(){return c.$loader.empty().remove(),b.resolve()}),b.promise()},b.prototype._eventify=function(){var a=this;return this._openerClickHandler=function(b){return b.preventDefault(),a.open()},this._resizeHandler=function(){return a.resizeDialog(),a.resizeEls()},this.$opener.bind("click",this._openerClickHandler),c.bind("resize orientationchange",this._resizeHandler)},b.prototype._prepareElsInsideDialog=function(){return this.$main=a(this.options.selector_main,this.$dialog),this.$holder=a(this.options.selector_holder,this.$dialog),this.$main.css("display","none")},b}(),a.fn.lycheeBox=function(b){return this.each(function(c,d){var f,g;return f=a(d),g=f.data("lycheebox"),null!=g&&g.destroy(),g=new e.Dialog(f,b),f.data("lycheebox",g)})},a.LycheeBox=e}(jQuery)}).call(this);